name: Build KeyCastOW

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

# 【重要】给予发版权限，否则无法创建 Release
permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    # 编译 (使用 v143 兼容模式)
    - name: Build
      run: msbuild keycastow.vcxproj /p:platform=win32 /p:Configuration=Release /p:PlatformToolset=v143

    # 【新增步骤】自动发布到 Releases 页面
    - name: Create Release
      uses: softprops/action-gh-release@v2
      if: startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main'
      with:
        tag_name: latest       # 强制使用 "latest" 这个标签
        name: Latest Auto Build # Release 的标题
        draft: false
        prerelease: false
        files: |               # 要上传的文件
          **/Release/*.exe
          **/Release/*.dll
